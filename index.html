<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Pendências</title>
<style>
body{font-family:Arial;margin:20px}
h2{margin-bottom:10px}
label{font-weight:bold;margin-top:6px;display:block}
select,input{padding:6px;margin-top:2px;min-width:200px}
button{padding:6px 12px;margin-top:10px;cursor:pointer}
table{border-collapse:collapse;margin-top:12px;font-size:13px;width:100%}
th,td{border:1px solid #ccc;padding:5px}
th{background:#f0f0f0}
.check{color:green;font-weight:bold}
.cross{color:red;font-weight:bold}
.message{margin-top:8px;font-weight:bold}
.success{color:green}.warning{color:#d97706}.error{color:red}

.filters{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
.filter{display:flex;flex-direction:column}

.compact body{margin:10px}
.compact .filters{flex-direction:column}
.compact table{font-size:11px}
.compact th,.compact td{padding:4px}
.compact h2{text-align:center}
.compact button{width:100%}
.toggle{float:right;margin-top:-40px}
</style>
</head>
<body>

<button class="toggle" onclick="toggleLayout()">Alternar layout</button>

<h2>Asa Norte - Consulta de Task</h2>

<div class="filters">
  <div class="filter">
    <label>Operação</label>
    <select id="operacao">
      <option>Asa Norte Campo Maior</option>
      <option>Asa Norte Teresina</option>
      <option>Asa Norte Parnaiba</option>
    </select>
  </div>

  <div class="filter">
    <label>RN</label>
    <input id="setor" maxlength="3" placeholder="000">
  </div>

  <div class="filter">
    <label>Cluster Primário</label>
    <select id="cluster_pri"></select>
  </div>

  <div class="filter">
    <label>Cluster Secundário</label>
    <select id="cluster_sec"></select>
  </div>

  <div class="filter">
    <label>Categoria</label>
    <select id="categoria"></select>
  </div>

  <div class="filter">
    <label>Valid</label>
    <select id="filtro_valid">
      <option value="">Todos</option>
      <option value="1">Somente ✅</option>
      <option value="0">Somente ❌</option>
    </select>
  </div>
</div>

<button onclick="buscar()">Buscar</button>

<div class="message" id="mensagem"></div>
<div id="tabela"></div>

<script>
const SUPABASE_URL="https://nzpquivtrvqwtsiooodr.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56cHF1aXZ0cnZxd3RzaW9vb2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTc2MDYsImV4cCI6MjA4MzI5MzYwNn0.xkoPm1W0-IFDYCoVgq2PFhXJ9Bg8oP9j9Eht7yIJzcM";

function toggleLayout(){
 document.documentElement.classList.toggle("compact");
}

const filtros=[["cluster_pri","Cluster_Pri"],["cluster_sec","Cluster_Sec"],["categoria","Categoria"]];

async function carregarFiltros(){
 for(let [id,col] of filtros){
  const r=await fetch(`${SUPABASE_URL}/rest/v1/pendencias?select=${col}`,{headers:{apikey:SUPABASE_KEY}});
  const d=await r.json();
  const vals=[...new Set(d.map(x=>x[col]).filter(Boolean))].sort();
  document.getElementById(id).innerHTML='<option value="">Todos</option>'+vals.map(v=>`<option>${v}</option>`).join('');
 }
}

async function buscar(){
 const params=[];
 if(operacao.value)params.push(`Operacao=eq.${encodeURIComponent(operacao.value)}`);
 if(setor.value)params.push(`Setor=eq.${setor.value}`);
 if(cluster_pri.value)params.push(`Cluster_Pri=eq.${encodeURIComponent(cluster_pri.value)}`);
 if(cluster_sec.value)params.push(`Cluster_Sec=eq.${encodeURIComponent(cluster_sec.value)}`);
 if(categoria.value)params.push(`Categoria=eq.${encodeURIComponent(categoria.value)}`);
 if(filtro_valid.value!=="")params.push(filtro_valid.value==="1"?"Valid=gt.0":"Valid=eq.0");

 const url=`${SUPABASE_URL}/rest/v1/pendencias?select=Pdv,Cluster_Pri,Cluster_Sec,Categoria,Meta,Real,Task,Valid&${params.join("&")}`;

 mensagem.textContent="Carregando...";mensagem.className="message";tabela.innerHTML="";
 try{
  const r=await fetch(url,{headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
  const d=await r.json();
  if(!d.length){mensagem.textContent="Nenhum registro.";mensagem.className="message warning";return;}
  mensagem.textContent=`${d.length} registro(s).`;mensagem.className="message success";
  let h="<table><tr><th>PDV</th><th>Cluster Pri</th><th>Cluster Sec</th><th>Categoria</th><th>Meta</th><th>Real</th><th>Task</th><th>Valid</th></tr>";
  d.forEach(r=>{
    h+=`<tr>
      <td>${r.Pdv||""}</td>
      <td>${r.Cluster_Pri||""}</td>
      <td>${r.Cluster_Sec||""}</td>
      <td>${r.Categoria||""}</td>
      <td>${r.Meta||""}</td>
      <td>${r.Real||""}</td>
      <td>${r.Task||""}</td>
      <td>${r.Valid>0?'<span class="check">✅</span>':'<span class="cross">❌</span>'}</td>
    </tr>`;
  });
  tabela.innerHTML=h+"</table>";
 }catch{
  mensagem.textContent="Erro.";mensagem.className="message error";
 }
}

const operacao=document.getElementById("operacao"),
setor=document.getElementById("setor"),
cluster_pri=document.getElementById("cluster_pri"),
cluster_sec=document.getElementById("cluster_sec"),
categoria=document.getElementById("categoria"),
filtro_valid=document.getElementById("filtro_valid"),
mensagem=document.getElementById("mensagem"),
tabela=document.getElementById("tabela");

carregarFiltros();
</script>
</body>
</html>
