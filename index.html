<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pendências</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f4f8;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      background: white;
      width: 100%;
      max-width: 420px;
      margin: 20px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    label { font-weight: bold; display: block; margin-top: 12px; }
    select, input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    button {
      margin-top: 16px;
      width: 100%;
      padding: 12px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled { background: #9ca3af; }
    .progress { margin-top: 12px; display: none; height: 6px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 100%; width: 0%; background: #2563eb; animation: loading 1.2s infinite; }
    @keyframes loading { 0%{width:0;} 50%{width:80%;} 100%{width:0;} }
    .message { margin-top: 10px; text-align: center; font-weight: bold; }
    .success{color:#16a34a;} .error{color:#dc2626;} .warning{color:#d97706;}
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background: #f1f5f9; }
  </style>
</head>
<body>
<div class="card">
  <h2>Consulta de Pendências</h2>

  <label>Operação</label>
  <select id="operacao">
    <option>Asa Norte Campo Maior</option>
    <option>Asa Norte Teresina</option>
    <option>Asa Norte Parnaiba</option>
  </select>

  <label>RN</label>
  <input id="setor" maxlength="3" placeholder="000">

  <label>Cluster Primário</label>
  <select id="cluster_pri"></select>

  <label>Cluster Secundário</label>
  <select id="cluster_sec"></select>

  <label>Categoria</label>
  <select id="categoria"></select>

  <button id="btnBuscar" onclick="buscar()">Buscar</button>

  <div class="progress" id="progress"><div class="progress-bar"></div></div>
  <div class="message" id="mensagem"></div>
  <div id="tabela"></div>
</div>

<script>
const SUPABASE_URL = "https://nzpquivtrvqwtsiooodr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56cHF1aXZ0cnZxd3RzaW9vb2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTc2MDYsImV4cCI6MjA4MzI5MzYwNn0.xkoPm1W0-IFDYCoVgq2PFhXJ9Bg8oP9j9Eht7yIJzcM";

const filtros = ["operacao", "cluster_pri", "cluster_sec", "categoria"];

async function carregarFiltros() {
  for (let f of filtros) {
    const col = f === "operacao" ? "Operacao" :
                f === "cluster_pri" ? "Cluster_Pri" :
                f === "cluster_sec" ? "Cluster_Sec" : "Categoria";

    const res = await fetch(`${SUPABASE_URL}/rest/v1/pendencias?select=${col}`, {
      headers: { apikey: SUPABASE_KEY }
    });

    const data = await res.json();
    const valores = [...new Set(data.map(d => d[col]).filter(v => v))];

    const select = document.getElementById(f);
    select.innerHTML = `<option value="">Todos</option>`;
    valores.sort().forEach(v => {
      select.innerHTML += `<option>${v}</option>`;
    });
  }
}

async function buscar() {
  const operacao = operacaoSel.value;
  const setor = setorInput.value;
  const cp = cluster_pri.value;
  const cs = cluster_sec.value;
  const cat = categoria.value;

  let query = `${SUPABASE_URL}/rest/v1/pendencias?`;

  const params = [];
  if (operacao) params.push(`Operacao=eq.${encodeURIComponent(operacao)}`);
  if (setor) params.push(`Setor=eq.${setor}`);
  if (cp) params.push(`Cluster_Pri=eq.${encodeURIComponent(cp)}`);
  if (cs) params.push(`Cluster_Sec=eq.${encodeURIComponent(cs)}`);
  if (cat) params.push(`Categoria=eq.${encodeURIComponent(cat)}`);

  query += params.join("&");

  const mensagem = document.getElementById("mensagem");
  const tabela = document.getElementById("tabela");
  const progress = document.getElementById("progress");
  const btn = document.getElementById("btnBuscar");

  mensagem.textContent = ""; tabela.innerHTML = "";
  btn.disabled = true; progress.style.display = "block";

  try {
    const res = await fetch(query, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    const data = await res.json();

    if (!data.length) {
      mensagem.textContent = "Nenhum registro encontrado.";
      mensagem.className = "message warning";
      return;
    }

    mensagem.textContent = `Encontrado(s) ${data.length} registro(s).`;
    mensagem.className = "message success";

    let html = "<table><tr>";
    Object.keys(data[0]).forEach(k => html += `<th>${k}</th>`);
    html += "</tr>";

    data.forEach(row => {
      html += "<tr>";
      Object.values(row).forEach(v => html += `<td>${v ?? ""}</td>`);
      html += "</tr>";
    });
    html += "</table>";
    tabela.innerHTML = html;

  } catch {
    mensagem.textContent = "Erro ao consultar dados.";
    mensagem.className = "message error";
  } finally {
    btn.disabled = false; progress.style.display = "none";
  }
}

const operacaoSel = document.getElementById("operacao");
const setorInput = document.getElementById("setor");
const cluster_pri = document.getElementById("cluster_pri");
const cluster_sec = document.getElementById("cluster_sec");
const categoria = document.getElementById("categoria");

carregarFiltros();
</script>
</body>
</html>

